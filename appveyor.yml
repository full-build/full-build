#
# configuration to suite git flow process
#
# all
# ---
#  - version is from tag name
#  - publish happens iif tag applied
#
# master
# ------
#  - push stable-release to GitHub
#  - push package to NuGet
#
# release/*
# ---------
#  - push beta-release to GitHub
#
# develop
# -------
#  - push alpha-release to GitHub

os: Visual Studio 2015

environment:
  GITHUB_TOKEN:
    secure: SNU7aaT74dbTXWCsWeFxWvfwJ4BLItFdO2EY7MYoEg9vec2EGBloH8PNDpkJbBKg

version: 2.6.{build}

init:
  - ps: $branch = $env:APPVEYOR_REPO_BRANCH
  - ps: If ($branch -eq "master" -And $env:APPVEYOR_REPO_TAG_NAME) { $version = $env:APPVEYOR_REPO_TAG_NAME }
  - ps: If ($branch -eq "develop") { $version = "v999.0" }
  - ps: If ($branch -like "release/*") { $version = $branch }
  - ps: If ($branch -like "feature/*") { $version = "v999.1" }
  - ps: if($version) { $posAfterVchar = $branch.LastIndexOf("v") + 1 }
  - ps: if($version) { $versionLength = $branch.Length - $posAfterVchar }
  - ps: if($version) { $version = $version.substring($posAfterVchar, $versionLength) }
  - ps: if($version) { $newVersion = "$version.$env:APPVEYOR_BUILD_NUMBER" }
  - ps: if($version) { Update-AppveyorBuild -Version "$newVersion" }
  - ps: if($version) { $env:APPVEYOR_BUILD_VERSION = $newVersion }
  - ps: Write-Host "Building version $env:APPVEYOR_BUILD_VERSION"

shallow_clone: true

build_script:
  - cmd: build-all.cmd %APPVEYOR_BUILD_VERSION%
  
test_script:
  - ps: . .\Push-TestResult.ps1

artifacts:
  - path: apps/full-build.zip
    name: app

  - path: apps/full-build.nupkg
    name: nuget

deploy:
  - provider: GitHub
    release: 'full-build v$(appveyor_build_version)'
    description: '$(appveyor_repo_commit) $(appveyor_repo_commit_message) stable'
    tag: 'stable'
    auth_token:
      secure: jFxLxYAyEMeg/TrfZ4oelM/HvdNR4ZtpiZYAqRrljzFdwiWBktkzh3N/UWLkFxpo
    artifact: apps/full-build.zip
    draft: true
    prerelease: false
    on:
      branch: master
      appveyor_repo_tag: true
  
  - provider: GitHub
    release: 'full-build v$(appveyor_build_version)'
    description: '$(appveyor_repo_commit) $(appveyor_repo_commit_message) beta'
    tag: 'beta'
    auth_token:
      secure: jFxLxYAyEMeg/TrfZ4oelM/HvdNR4ZtpiZYAqRrljzFdwiWBktkzh3N/UWLkFxpo
    artifact: apps/full-build.zip
    draft: false
    prerelease: true
    on:
      branch: release/*
      appveyor_repo_tag: true  

  - provider: GitHub
    release: 'full-build v$(appveyor_build_version)'
    description: '$(appveyor_repo_commit) $(appveyor_repo_commit_message) alpha'
    tag: 'alpha'
    auth_token:
      secure: jFxLxYAyEMeg/TrfZ4oelM/HvdNR4ZtpiZYAqRrljzFdwiWBktkzh3N/UWLkFxpo
    artifact: apps/full-build.zip
    draft: false
    prerelease: true
    on:
      branch: develop
      appveyor_repo_tag: true  
      
  - provider: NuGet
    api_key:
      secure: Fa/KRLSPeo1w78xW6Yb6FJv3amW/BRcLKpy7DW7e0/mdsiug7GBA36twg2HOUCSS
    skip_symbols: true
    symbol_server:
    artifacts: apps/full-build.nupkg
    on:
      branch: master
      appveyor_repo_tag: true  
      
notifications:
  - provider: GitHubPullRequest
    auth_token:
      secure: jFxLxYAyEMeg/TrfZ4oelM/HvdNR4ZtpiZYAqRrljzFdwiWBktkzh3N/UWLkFxpo
    template: '{{#passed}}:white_check_mark:{{/passed}}{{#failed}}:x:{{/failed}} [Build {{&projectName}} {{buildVersion}} {{status}}]({{buildUrl}}) (commit {{commitUrl}} by @{{&commitAuthorUsername}})'

  - provider: Slack
    incoming_webhook:
      secure: gA2eVzMFIFRHZpWx6bDTbKCKGFOWEe3zRukzC4PTWklKnLTsIzm/TLqa/oGgPSFiSR7DsBLKpp1Tkd4eIEy2QlzqAwFx4IknxGh4igmbB7k=
    channel: '#builds'
