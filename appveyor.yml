#
# master
# ------
#  - push release to GitHub as stable
#  - package is stable and pushed to NuGet
#
# release/*
# ---------
#  - push to GitHub as draft/pre-release (beta)
#  - package is beta and pushed to NuGet
#
# develop
# -------
#  - push to GitHub as draft/pre-release (alpha)
#  - package is alpha
#

os: Visual Studio 2015

environment:
  GITHUB_TOKEN:
    secure: SNU7aaT74dbTXWCsWeFxWvfwJ4BLItFdO2EY7MYoEg9vec2EGBloH8PNDpkJbBKg

version: 3.0.{build}

init:
  - ps: If ($env:APPVEYOR_REPO_BRANCH -like "release/*") { $version = $env:APPVEYOR_REPO_BRANCH }
  - ps: if ($version) { $posAfterVchar = $version.LastIndexOf("v") + 1 }
  - ps: if ($version) { $versionLength = $version.Length - $posAfterVchar }
  - ps: if ($version) { $version = $version.substring($posAfterVchar, $versionLength) }
  - ps: if ($version) { $newVersion = "$version.$env:APPVEYOR_BUILD_NUMBER" }
  - ps: if ($version) { Update-AppveyorBuild -Version "$newVersion" }
  - ps: if ($version) { $env:APPVEYOR_BUILD_VERSION = $newVersion }
  - ps: if ($version) { $env:BUILD_VERSION_STATUS = "-beta" }
  - ps: if ($version) { Set-AppveyorBuildVariable -Name BUILD_VERSION_STATUS -Value $env:BUILD_VERSION_STATUS }
  - ps: Write-Host "Building version $env:APPVEYOR_BUILD_VERSION $env:BUILD_VERSION_STATUS"

shallow_clone: true

build_script:
  - cmd: build-all.cmd %APPVEYOR_BUILD_VERSION% %BUILD_VERSION_STATUS%
  
test_script:
  - ps: . .\Push-TestResult.ps1

artifacts:
  - path: apps/full-build.zip
    name: app

  - path: apps/full-build.nupkg
    name: nuget

deploy:
  - provider: GitHub
    release: 'full-build v$(appveyor_build_version) stable'
    description: '$(appveyor_repo_commit) $(appveyor_repo_commit_message)'
    auth_token:
      secure: jFxLxYAyEMeg/TrfZ4oelM/HvdNR4ZtpiZYAqRrljzFdwiWBktkzh3N/UWLkFxpo
    artifact: apps/full-build.zip
    draft: false
    prerelease: false
    force_update: true
    on:
      branch: master
      appveyor_repo_tag: false

  - provider: GitHub
    release: 'full-build v$(appveyor_build_version) beta'
    description: '$(appveyor_repo_commit) $(appveyor_repo_commit_message)'
    auth_token:
      secure: jFxLxYAyEMeg/TrfZ4oelM/HvdNR4ZtpiZYAqRrljzFdwiWBktkzh3N/UWLkFxpo
    artifact: apps/full-build.zip
    draft: false
    prerelease: true
    force_update: true
    on:
      branch: /release\/.*/
      appveyor_repo_tag: false
      
  - provider: GitHub
    release: 'full-build v$(appveyor_build_version) alpha'
    description: '$(appveyor_repo_commit) $(appveyor_repo_commit_message)'
    auth_token:
      secure: jFxLxYAyEMeg/TrfZ4oelM/HvdNR4ZtpiZYAqRrljzFdwiWBktkzh3N/UWLkFxpo
    artifact: apps/full-build.zip
    draft: true
    prerelease: true
    force_update: true
    on:
      branch: develop
      appveyor_repo_tag: false

  - provider: NuGet
    api_key:
      secure: Fa/KRLSPeo1w78xW6Yb6FJv3amW/BRcLKpy7DW7e0/mdsiug7GBA36twg2HOUCSS
    skip_symbols: true
    symbol_server:
    artifacts: apps/full-build.nupkg
    on:
      branch: master
      appveyor_repo_tag: false  

  - provider: NuGet
    api_key:
      secure: Fa/KRLSPeo1w78xW6Yb6FJv3amW/BRcLKpy7DW7e0/mdsiug7GBA36twg2HOUCSS
    skip_symbols: true
    symbol_server:
    artifacts: apps/full-build.nupkg
    on:
      branch: /release\/.*/
      appveyor_repo_tag: false  
      
notifications:
  - provider: GitHubPullRequest
    auth_token:
      secure: jFxLxYAyEMeg/TrfZ4oelM/HvdNR4ZtpiZYAqRrljzFdwiWBktkzh3N/UWLkFxpo
    template: '{{#passed}}:white_check_mark:{{/passed}}{{#failed}}:x:{{/failed}} [Build {{&projectName}} {{buildVersion}} {{status}}]({{buildUrl}}) (commit {{commitUrl}} by @{{&commitAuthorUsername}})'

  - provider: Slack
    incoming_webhook:
      secure: gA2eVzMFIFRHZpWx6bDTbKCKGFOWEe3zRukzC4PTWklKnLTsIzm/TLqa/oGgPSFiSR7DsBLKpp1Tkd4eIEy2QlzqAwFx4IknxGh4igmbB7k=
    channel: '#builds'
